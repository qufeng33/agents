# FastAPI 架构设计
> 说明：`user` 是数据库保留字，示例统一使用表名 `app_user`、API 路径 `/users`。

专注于**设计和规划**，输出设计文档而非代码。

## 设计原则
- 先明确业务目标与约束，再决定技术方案
- 以核心价值为主线拆解需求，避免过度设计
- 数据模型由业务实体与查询模式驱动
- 技术选型服务于可维护性与交付效率
- 输出文档要可落地且可追溯

## 最佳实践
1. 先列出非功能需求（性能、安全、合规）再做拆分
2. 以“核心流程”定义最小可交付范围
3. 将需求拆成独立可验证的功能单元
4. 在设计阶段明确数据量级与增长预期
5. 技术选型只记录关键决策与理由

## 目录
- `需求分析流程`
- `技术选型决策`
- `数据库设计`
- `API 设计`
- `项目结构选择`
- `设计文档模板`
- `输出物`

---

## 需求分析流程

### Step 1: 理解业务需求

**关键问题清单**：
- 功能的核心价值是什么？
- 谁是使用者？
- 预期的数据量级？
- 性能要求？（响应时间、并发量）
- 是否需要实时性？

### Step 2: 拆分需求

将大需求拆分为可实现的小单元（模块/子功能/关键流程）。

> 如果需要更详细的拆分结构，可在设计文档中补充树形分解或流程图。

### Step 3: 确定优先级

| 优先级 | 标准 | 示例 |
|--------|------|------|
| P0 | 核心功能，必须有 | 用户登录、创建订单 |
| P1 | 重要功能，应该有 | 订单状态通知 |
| P2 | 增强功能，可以有 | 订单数据分析 |

---

## 技术选型决策

### 核心技术栈（默认）

| 组件 | 选择 | 理由 |
|------|------|------|
| 框架 | FastAPI | 异步、类型安全、自动文档 |
| ORM | SQLAlchemy 2.0 | 成熟、异步支持、灵活 |
| 数据库 | PostgreSQL | 功能丰富、可靠 |
| 验证 | Pydantic v2 | 性能好、与 FastAPI 集成 |

### 扩展组件选型

根据需求选择是否引入：

- **缓存 (Redis)**：高频读取、Session 存储、分布式锁等场景
- **异步任务**：简单后台任务用 `BackgroundTasks`，复杂任务用 Celery/ARQ
- **消息队列**：微服务通信或事件驱动时引入
- **搜索引擎**：全文检索与复杂聚合时引入

> 如需更细致对比，可在设计文档中补充“采用/不采用”的理由。

---

## 数据库设计

### 设计原则

1. **先理解业务实体和关系**
2. **从核心实体开始设计**
3. **考虑查询模式决定索引**
4. **预留扩展字段**

### 实体识别

以业务描述为输入，抽取关键名词并识别实体与关系。

### 命名约定

| 元素 | 规范 | 示例 |
|------|------|------|
| 表名 | snake_case，单数 | `user`, `order_item` |
| 字段 | snake_case | `created_at`, `user_id` |
| 时间字段 | `_at`（datetime）, `_date`（date） | `created_at`, `birth_date` |
| 布尔字段 | `is_` 或 `has_` 前缀 | `is_active`, `has_verified` |
| 外键 | `{table}_id` | `user_id`, `order_id` |
| 索引 | `ix_{table}_{columns}` | `ix_user_username` |

推荐策略与数据库文档一致（单数表名 + UUIDv7）：见 [ORM 基类](./fastapi-database-orm.md)。

### 表设计模板

```markdown
## 表名: {entity}

描述: {功能描述}

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | UUIDv7 | PK | 主键 |
| ... | ... | ... | ... |
| created_at | datetime (tz) | NOT NULL | 创建时间 |
| updated_at | datetime (tz) | NOT NULL | 更新时间 |

索引:
- `ix_{table}_{field}` on `field` - 用于 xxx 查询

关系:
- belongs_to: {parent_table}
- has_many: {child_table}
```

### 常见设计模式

| 模式 | 实现 |
|------|------|
| 软删除 | `deleted_at: TIMESTAMP NULL` |
| 状态机 | `status: VARCHAR(20)` (draft/pending/approved) |
| 多对多 | 关联表含额外字段 (quantity, price) |

---

## API 设计

### RESTful 规范

| 操作 | HTTP 方法 | 路径示例 |
|------|-----------|----------|
| 列表 | GET | /users |
| 详情 | GET | /users/{id} |
| 创建 | POST | /users |
| 全量更新 | PUT | /users/{id} |
| 部分更新 | PATCH | /users/{id} |
| 删除 | DELETE | /users/{id} |

### API 设计模板

API 文档至少包含接口名称、路径、输入参数、响应状态码与错误语义；更复杂的接口可补充示例与流程说明。

---

## 项目结构选择

| 场景 | 推荐结构 |
|------|----------|
| 小项目 / 原型 / 单人开发 | 简单结构 |
| 预期 3+ 业务模块 | 模块化结构 |
| 团队 2+ 人协作 | 模块化结构 |

> 详见 [项目结构详解](./fastapi-project-structure.md)

---

## 设计文档模板

```markdown
# {功能名称} 设计文档

## 1. 背景和目标
{为什么要做这个功能？解决什么问题？}

## 2. 需求分析
- 功能需求：{要做什么}
- 非功能需求：{性能/安全/合规}

## 3. 技术方案
- 技术选型：{关键组件与理由}
- 数据模型：{核心表与关系}
- API 设计：{接口列表与约束}

## 4. 实现计划
{阶段划分、产出与验收标准}

## 5. 风险和依赖
- 风险：{可能的问题}
- 依赖：{外部依赖}
```

> 复杂系统可额外补充“数据流/时序图/容量规划”。

---

## 输出物

架构设计完成后，应输出：

1. **设计文档**（使用上述模板）
2. **数据库表设计**
3. **API 列表**
4. **技术选型决策记录**

这些文档将作为开发阶段的输入。
