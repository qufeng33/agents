# FastAPI 架构设计

专注于**设计和规划**，输出设计文档而非代码。

---

## 需求分析流程

### Step 1: 理解业务需求

```
用户需求 → 核心问题是什么？
         → 要解决什么业务场景？
         → 有哪些约束条件？
```

**关键问题清单**：
- 功能的核心价值是什么？
- 谁是使用者？
- 预期的数据量级？
- 性能要求？（响应时间、并发量）
- 是否需要实时性？

### Step 2: 拆分需求

将大需求拆分为可实现的小单元：

```
大需求: 用户订单系统
  ├─ 用户管理
  │   ├─ 用户注册
  │   ├─ 用户登录
  │   └─ 用户信息修改
  ├─ 商品管理
  │   ├─ 商品列表
  │   └─ 商品详情
  └─ 订单管理
      ├─ 创建订单
      ├─ 订单列表
      └─ 订单状态变更
```

### Step 3: 确定优先级

| 优先级 | 标准 | 示例 |
|--------|------|------|
| P0 | 核心功能，必须有 | 用户登录、创建订单 |
| P1 | 重要功能，应该有 | 订单状态通知 |
| P2 | 增强功能，可以有 | 订单数据分析 |

---

## 技术选型决策

### 核心技术栈（默认）

| 组件 | 选择 | 理由 |
|------|------|------|
| 框架 | FastAPI | 异步、类型安全、自动文档 |
| ORM | SQLAlchemy 2.0 | 成熟、异步支持、灵活 |
| 数据库 | PostgreSQL | 功能丰富、可靠 |
| 验证 | Pydantic v2 | 性能好、与 FastAPI 集成 |

### 扩展组件选型

根据需求选择是否引入：

#### 缓存 (Redis)

| 需要引入 | 不需要 |
|----------|--------|
| 高频读取数据（配置、热点） | 简单 CRUD 应用 |
| Session 存储 | 数据量小、并发低 |
| 分布式锁 | 实时性要求不高 |

#### 异步任务

| 场景 | 选择 |
|------|------|
| 简单后台任务 | FastAPI BackgroundTasks |
| 定时任务 | APScheduler |
| 复杂任务队列 | Celery / ARQ |

#### 消息队列 (RabbitMQ/Kafka)

| 需要引入 | 不需要 |
|----------|--------|
| 微服务间通信 | 单体应用 |
| 事件驱动架构 | Redis Pub/Sub 能满足 |
| 高吞吐量消息处理 | |

#### 搜索引擎 (Elasticsearch)

| 需要引入 | 不需要 |
|----------|--------|
| 全文搜索 | PostgreSQL 全文搜索能满足 |
| 复杂查询和聚合 | 简单的 LIKE 查询 |
| 日志分析 | |

---

## 数据库设计

### 设计原则

1. **先理解业务实体和关系**
2. **从核心实体开始设计**
3. **考虑查询模式决定索引**
4. **预留扩展字段**

### 实体识别

```
业务需求 → 识别名词 → 筛选核心实体

示例："用户可以创建订单购买商品"
名词：用户、订单、商品
核心实体：User, Order, Product
关系：User 1:N Order, Order N:M Product
```

### 命名约定

| 元素 | 规范 | 示例 |
|------|------|------|
| 表名 | snake_case，单数 | `user`, `order_item` |
| 字段 | snake_case | `created_at`, `user_id` |
| 时间字段 | `_at`（datetime）, `_date`（date） | `created_at`, `birth_date` |
| 布尔字段 | `is_` 或 `has_` 前缀 | `is_active`, `has_verified` |
| 外键 | `{table}_id` | `user_id`, `order_id` |
| 索引 | `ix_{table}_{columns}` | `ix_user_email` |

推荐策略与数据库文档一致（单数表名 + UUIDv7）：见 [数据库设计](./fastapi-database.md)。

### 表设计模板

```markdown
## 表名: {entity}

描述: {功能描述}

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | UUIDv7 | PK | 主键 |
| ... | ... | ... | ... |
| created_at | datetime (tz) | NOT NULL | 创建时间 |
| updated_at | datetime (tz) | NOT NULL | 更新时间 |

索引:
- `ix_{table}_{field}` on `field` - 用于 xxx 查询

关系:
- belongs_to: {parent_table}
- has_many: {child_table}
```

### 常见设计模式

| 模式 | 实现 |
|------|------|
| 软删除 | `deleted_at: TIMESTAMP NULL` |
| 状态机 | `status: VARCHAR(20)` (draft/pending/approved) |
| 多对多 | 关联表含额外字段 (quantity, price) |

---

## API 设计

### RESTful 规范

| 操作 | HTTP 方法 | 路径示例 |
|------|-----------|----------|
| 列表 | GET | /users |
| 详情 | GET | /users/{id} |
| 创建 | POST | /users |
| 全量更新 | PUT | /users/{id} |
| 部分更新 | PATCH | /users/{id} |
| 删除 | DELETE | /users/{id} |

### API 设计模板

```markdown
## API: {功能名称}

`{METHOD} /api/v1/{resource}`

描述: {功能描述}

### 请求

| 参数 | 位置 | 类型 | 必填 | 说明 |
|------|------|------|------|------|
| id | path | UUID | Y | 资源 ID |
| name | body | string | Y | 名称 |

### 响应

| 状态码 | 说明 |
|--------|------|
| 200 | 成功 |
| 404 | 不存在 |
| 422 | 验证失败 |
```

---

## 项目结构选择

| 场景 | 推荐结构 |
|------|----------|
| 小项目 / 原型 / 单人开发 | 简单结构 |
| 预期 3+ 业务模块 | 模块化结构 |
| 团队 2+ 人协作 | 模块化结构 |

> 详见 [项目结构详解](./fastapi-project-structure.md)

---

## 设计文档模板

```markdown
# {功能名称} 设计文档

## 1. 背景和目标

{为什么要做这个功能？解决什么问题？}

## 2. 需求分析

### 2.1 功能需求
- [ ] 需求点 1
- [ ] 需求点 2

### 2.2 非功能需求
- 性能：{要求}
- 安全：{要求}

## 3. 技术方案

### 3.1 技术选型
| 组件 | 选择 | 理由 |
|------|------|------|

### 3.2 数据模型
{表设计}

### 3.3 API 设计
{接口列表}

## 4. 实现计划
| 阶段 | 内容 | 产出 |
|------|------|------|

## 5. 风险和依赖
- 风险：{可能的问题}
- 依赖：{外部依赖}
```

---

## 输出物

架构设计完成后，应输出：

1. **设计文档**（使用上述模板）
2. **数据库表设计**
3. **API 列表**
4. **技术选型决策记录**

这些文档将作为开发阶段的输入。
