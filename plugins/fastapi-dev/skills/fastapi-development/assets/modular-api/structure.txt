# 模块化项目结构（按领域组织）
# 适用于：中大型项目、团队开发、长期维护、> 20 个文件

app/
├── __init__.py
├── main.py                 # 应用入口（create_app 工厂模式）
├── config.py               # 全局配置（pydantic-settings）
├── dependencies.py         # 全局共享依赖（DBSession 等）
│
├── api/                    # API 版本管理
│   ├── __init__.py
│   └── v1/
│       ├── __init__.py
│       └── router.py       # v1 路由聚合
│
├── modules/                # 功能模块（按领域划分，单数命名）
│   ├── __init__.py
│   │
│   ├── user/               # 用户模块（完全自包含）
│   │   ├── __init__.py
│   │   ├── router.py       # HTTP 处理，注入 Service
│   │   ├── schemas.py      # Pydantic 模型
│   │   ├── models.py       # ORM 模型（继承 Base + AuditMixin）
│   │   ├── repository.py   # 数据访问层（软删除查询）
│   │   ├── service.py      # 业务逻辑层
│   │   ├── dependencies.py # 模块依赖注入链
│   │   └── exceptions.py   # 模块异常
│   │
│   └── item/
│       └── ...
│
├── schemas/                # 共享 Schema
│   ├── __init__.py
│   └── response.py         # BaseSchema, ApiResponse, ApiPagedResponse
│
├── core/                   # 核心基础设施
│   ├── __init__.py
│   ├── database.py         # Base（UUIDv7+软删除+时间戳）、get_db()、filter_active()
│   ├── context.py          # RequestContext（contextvars 用户上下文）
│   ├── audit.py            # AuditMixin、AuditLog、事件监听
│   ├── exception_handlers.py  # setup_exception_handlers
│   ├── exceptions.py       # 全局异常定义
│   ├── middlewares.py      # RequestContextMiddleware / LoggingMiddleware / ExceptionMiddleware
│   ├── routers.py          # setup_routers
│   └── security.py         # JWT、密码哈希
│
└── tests/
    ├── conftest.py
    └── test_user.py

# main.py 中使用 setup_xxx 函数：
# setup_middlewares(application)
# setup_routers(application)
# setup_exception_handlers(application)

# 分层架构：
# Router → Service → Repository → Database
#   ↓         ↓           ↓
# HTTP处理  业务逻辑    数据访问（事务由 get_db() 自动管理）

# ORM 基类特性（Base）：
# - id: UUIDv7 主键（时间有序，分布式友好）
# - created_at, updated_at: 时间戳（带时区，UTC）
# - deleted_at: 软删除
# - soft_delete(), restore(), is_deleted

# 审计特性（AuditMixin）：
# - created_by, updated_by: 操作者（自动注入）
# - 通过 RequestContextMiddleware + contextvars 自动填充

# 事务管理：
# - get_db() 依赖自动 commit/rollback
# - Repository 只用 flush/refresh，不调用 commit
# - Service 层编排业务逻辑，一个方法 = 一个事务

# 软删除查询：
# - filter_active(stmt): 过滤已删除记录
# - get_by_id(): 默认排除已删除
# - get_by_id_including_deleted(): 包含已删除（管理员）

# 命名约定：
# - 模块目录使用单数（user, item, order）
# - API 资源路径使用复数（/users, /items, /orders）
# - 类名使用单数（User, UserService, UserRepository）
