# 模块化项目结构（按领域组织）
# 适用于：中大型项目、团队开发、长期维护、> 20 个文件

app/
├── __init__.py
├── main.py                 # 应用入口（create_app 工厂模式）
├── config.py               # 全局配置（pydantic-settings）
├── dependencies.py         # 全局共享依赖（DBSession 等）
├── exceptions.py           # 全局异常 + setup_exception_handlers
│
├── api/                    # API 版本管理
│   ├── __init__.py
│   └── v1/
│       ├── __init__.py
│       └── router.py       # v1 路由聚合
│
├── modules/                # 功能模块（按领域划分，单数命名）
│   ├── __init__.py
│   │
│   ├── user/               # 用户模块（完全自包含）
│   │   ├── __init__.py
│   │   ├── router.py       # HTTP 处理，注入 Service
│   │   ├── schemas.py      # Pydantic 模型
│   │   ├── models.py       # ORM 模型
│   │   ├── repository.py   # 数据访问层（只用 flush/refresh）
│   │   ├── service.py      # 业务逻辑层
│   │   ├── dependencies.py # 模块依赖注入链
│   │   └── exceptions.py   # 模块异常
│   │
│   └── item/
│       └── ...
│
├── core/                   # 核心基础设施
│   ├── __init__.py
│   ├── database.py         # get_db() + init/close_database
│   ├── middlewares.py      # setup_middlewares
│   ├── routers.py          # setup_routers
│   └── security.py         # 密码哈希等
│
└── tests/
    ├── conftest.py
    └── test_user.py

# main.py 中使用 setup_xxx 函数：
# setup_middlewares(application)
# setup_routers(application)
# setup_exception_handlers(application)

# 分层架构：
# Router → Service → Repository → Database
#   ↓         ↓           ↓
# HTTP处理  业务逻辑    数据访问（事务由 get_db() 自动管理）

# 事务管理：
# - get_db() 依赖自动 commit/rollback
# - Repository 只用 flush/refresh，不调用 commit
# - Service 层编排业务逻辑，一个方法 = 一个事务

# 命名约定：
# - 模块目录使用单数（user, item, order）
# - API 资源路径使用复数（/users, /items, /orders）
# - 类名使用单数（User, UserService, UserRepository）

# 特点：
# - 每个模块完全自包含（router/schema/service/repository/model）
# - 清晰的分层：Router → Service → Repository
# - 便于测试：可以单独 mock Repository
# - 修改一个功能只需改一个目录
# - 便于团队分工，减少冲突
