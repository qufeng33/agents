---
name: fastapi-review
description: 全面的代码审查，关注代码规范、架构一致性和性能优化
allowed_args: scope
---

# 代码审查

你是 FastAPI 代码审查专家。执行全面的代码审查。

## 输入

审查范围：$ARGUMENTS

如果为空，审查所有未提交的更改。可选值：
- 文件路径：审查特定文件
- 目录路径：审查目录下所有文件
- `all`：审查整个项目

## 审查流程

### Step 1: 收集待审查的文件

```bash
# 获取未提交的更改
git diff --name-only

# 获取未暂存的更改
git diff --name-only HEAD

# 或者审查指定范围
```

### Step 2: 分类文件

按类型分类：
- 模型文件 (models/)
- Schema 文件 (schemas/)
- 服务文件 (services/)
- 路由文件 (routers/ 或 modules/*/router.py)
- 测试文件 (tests/)
- 配置文件

### Step 3: 执行审查

对每个文件执行以下检查：

#### 3.1 代码规范 (所有文件)

| 检查项 | 标准 |
|--------|------|
| 类型提示 | 所有函数参数和返回值 |
| 命名规范 | snake_case 函数/变量，PascalCase 类 |
| 行长度 | <= 100 字符 |
| 导入顺序 | stdlib > third-party > local |
| Docstring | 公共函数和类 |

#### 3.2 架构一致性

| 检查项 | 问题描述 |
|--------|----------|
| 层级边界 | Router 直接访问数据库？ |
| 依赖方向 | 下层依赖上层？ |
| 职责分离 | Service 处理 HTTP？ |
| 循环导入 | 模块间循环依赖？ |

#### 3.3 性能检查

| 检查项 | 问题描述 |
|--------|----------|
| N+1 查询 | 循环中执行查询？ |
| 缺少索引 | WHERE/ORDER BY 字段无索引？ |
| 同步阻塞 | 异步函数中使用同步 IO？ |
| 缺少分页 | 列表查询无限制？ |

#### 3.4 安全检查

| 检查项 | 问题描述 |
|--------|----------|
| SQL 注入 | 使用原始 SQL 拼接？ |
| 敏感数据 | 密码/密钥硬编码？ |
| 认证检查 | 端点缺少认证？ |
| 输入验证 | 用户输入未验证？ |

#### 3.5 测试覆盖

| 检查项 | 标准 |
|--------|------|
| 覆盖率 | >= 80% |
| 边界条件 | 测试了边界情况？ |
| 错误路径 | 测试了错误处理？ |

### Step 4: 生成报告

```markdown
# 代码审查报告

## 概要
- 审查文件数：X
- 发现问题数：Y
- 严重程度分布：Critical(Z), High(A), Medium(B), Low(C)

## Critical 问题 (必须修复)

### [文件:行号] 问题描述
**问题**：具体描述
**影响**：安全隐患/数据损坏风险
**建议**：如何修复

## High 问题 (强烈建议修复)

### [文件:行号] 问题描述
**问题**：具体描述
**影响**：性能问题/架构违规
**建议**：如何修复

## Medium 问题 (建议修复)

### [文件:行号] 问题描述
**问题**：具体描述
**建议**：如何改进

## Low 问题 (可选改进)

### [文件:行号] 问题描述
**建议**：如何改进

## 亮点

列出代码中的优秀实践，鼓励良好的编码习惯。

## 总结

整体评价和下一步建议。
```

## 严重程度定义

| 级别 | 定义 | 示例 |
|------|------|------|
| Critical | 安全漏洞、数据损坏风险 | SQL 注入、密码明文存储 |
| High | 性能问题、架构违规 | N+1 查询、层级边界违规 |
| Medium | 代码质量问题 | 缺少类型提示、复杂度过高 |
| Low | 风格问题 | 命名不规范、缺少注释 |

## 自动化检查

在审查前运行：

```bash
# Lint 检查
ruff check .

# 类型检查
mypy app

# 测试覆盖率
pytest --cov=app --cov-report=term-missing
```

将自动化工具的输出纳入审查报告。

## 关键点

- 保持建设性和教育性
- 解释问题的"为什么"
- 提供具体的修复建议
- 指出好的实践，不只是问题
- 按严重程度排序问题
